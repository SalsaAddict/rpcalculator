var __extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),module=angular.module("rpcalc",["ngRoute","ngStorage"]),RPCalculator;module.config(["$routeProvider",function(n){n.when("/workbook",{templateUrl:"Views/workbook.html",controller:RPCalculator.Workbook.Controller,controllerAs:"$ctrl"}).when("/worksheets/:index",{templateUrl:"Views/worksheet.html",controller:RPCalculator.Scoring.Controller,controllerAs:"$ctrl"}).when("/judges/:index",{templateUrl:"Views/editor.html",controller:RPCalculator.Judges.Controller,controllerAs:"$ctrl"}).when("/competitors/:index",{templateUrl:"Views/editor.html",controller:RPCalculator.Competitors.Controller,controllerAs:"$ctrl"}).otherwise({redirectTo:"/workbook"}).caseInsensitiveMatch=!0}]);module.run(["$rootScope",function(n){n.textPattern=RPCalculator.textPattern;n.numberPattern=RPCalculator.numberPattern;n.vclass=function(n,t,i){t===void 0&&(t="is-valid");i===void 0&&(i="is-invalid");var r={};return t!==null&&Object.defineProperty(r,t,{get:function(){return n.$valid},enumerable:!0}),i!==null&&Object.defineProperty(r,i,{get:function(){return n.$invalid},enumerable:!0}),r}}]),function(n){"use strict";function i(n){return angular.isUndefined(n)?!0:n===null?!0:angular.isArray(n)?n.length===0:angular.isObject(n)?angular.toJson(n)===angular.toJson({}):String(n).trim()===""?!0:n===NaN?!0:!1}function r(n,t){return i(n)?t:n}function t(n,t,i){var r=n[t];n[t]=n[i];n[i]=r}function u(n,i){t(n,i,i-1)}function f(n,i){t(n,i,i+1)}function e(t){var i=new RegExp(n.numberPattern);if(i.test(t))return parseInt(i.exec(t)[1],10)}n.maxJudges=7;n.maxCompetitors=8;n.textPattern="(^[\\w\\s-]+$)";n.numberPattern="(^\\d+$)";n.defaultWorkbookTitle="Untitled Workbook";n.defaultWorksheetTitle="Untitled Worksheet";n.isBlank=i;n.ifBlank=r;n.swap=t;n.swapUp=u;n.swapDown=f;n.toInt=e}(RPCalculator||(RPCalculator={})),function(n){"use strict";var r,u,t,f,e,i,o,s,h,c;(function(t){var i=function(){function t(n,t,i){this.$workbook=n;this.$location=t;this.$window=i;this._collapsed=!0}return Object.defineProperty(t.prototype,"collapsed",{get:function(){return this._collapsed},enumerable:!0,configurable:!0}),t.prototype.toggle=function(t,i){t&&(t.preventDefault(),event.stopPropagation());this._collapsed=n.ifBlank(i,!this._collapsed)},t.prototype.go=function(n,t){this.toggle(t);this.$location.path(n)},t.prototype.download=function(t){this.toggle(t,!0);var i=document.createElement("a");i.href="data:text/json;charset=utf-8, "+encodeURIComponent(angular.toJson(this.$workbook.workbook,!1));i.download=n.ifBlank(this.$workbook.workbook.title,n.defaultWorkbookTitle)+".json";i.click()},t.prototype.upload=function(n){this.toggle(n,!0);var t=document.getElementById("upload");t.click()},t.prototype.example=function(n){var t=this;(this.toggle(n,!0),this.$window.confirm("The current workbook will be overwritten. Are you sure you want to continue?"))&&this.$workbook.loadExample().then(function(){t.$location.path("/workbook")})},t.prototype.$postLink=function(){},t.$inject=["$workbook","$location","$window"],t}();t.Controller=i})(r=n.Menu||(n.Menu={})),function(t){var r=function(){function t(n,t,i,r){this.$localStorage=n;this.$location=t;this.$http=i;this.$q=r;angular.isUndefined(n.workbook)&&this.loadExample()}return t.prototype.go=function(n,t){n===void 0&&(n="/workbook");t>=0&&(n+="/"+t);this.$location.path(n)},t.prototype.loadExample=function(){var n=this;return this.$http.get("example.json").then(function(t){n.$localStorage.workbook=t.data})},Object.defineProperty(t.prototype,"workbook",{get:function(){return n.ifBlank(this.$localStorage.workbook,{title:null,worksheets:[]})},set:function(n){this.$localStorage.workbook=n},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"title",{get:function(){return angular.isUndefined(this.workbook.title)&&(this.workbook.title="New Workbook"),this.workbook.title},set:function(n){this.workbook.title=n},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"worksheets",{get:function(){return angular.isArray(this.workbook.worksheets)||(this.workbook.worksheets=[]),this.workbook.worksheets},enumerable:!0,configurable:!0}),t.prototype.validateJudges=function(t){return n.isBlank(this.judgesValidationError(t))},t.prototype.judgesValidationError=function(t){var r,i;if(n.isBlank(t)||!angular.isArray(t)||t.length<3)return"There must be at least 3 judges";if(t.length>n.maxJudges)return"There cannot be more than "+n.maxJudges+" judges";if(t.length%2==0)return"There must be an odd number of judges";for(r=[],i=0;i<t.length;i++){if(n.isBlank(t[i])||n.isBlank(t[i].name))return"Each judge must have a name";if(r.indexOf(t[i].name)>=0)return"Each judge must have a unique name";r.push(t[i].name)}return},t.prototype.competitorsValidationError=function(t){var r,u,i;if(n.isBlank(t)||!angular.isArray(t)||t.length<2)return"There must be at least 2 competitors";if(t.length>n.maxCompetitors)return"There cannot be more than "+n.maxCompetitors+" competitors";for(r=[],u=[],i=0;i<t.length;i++){if(n.isBlank(t[i])||n.isBlank(t[i].id))return"Each competitor must have a number";if(r.indexOf(t[i].id)>=0)return"Each competitor must have a unique number";if(n.isBlank(t[i].name))return"Each competitor must have a name";if(u.indexOf(t[i].name)>=0)return"Each competitor must have a unique name";r.push(t[i].id);u.push(t[i].name)}return},t.prototype.validateCompetitors=function(t){return n.isBlank(this.competitorsValidationError(t))},t.$inject=["$localStorage","$location","$http","$q"],t}(),i;t.Service=r;i=function(){function t(n,t){this.$workbook=n;this.$window=t}return Object.defineProperty(t.prototype,"defaultWorkbookTitle",{get:function(){return n.defaultWorkbookTitle},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"defaultWorksheetTitle",{get:function(){return n.defaultWorksheetTitle},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"title",{get:function(){return this.$workbook.title},set:function(n){this.$workbook.title=n},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"worksheets",{get:function(){return this.$workbook.worksheets},enumerable:!0,configurable:!0}),t.prototype.add=function(){this.worksheets.push({title:null,judges:[],competitors:[]})},t.prototype.remove=function(n){this.$window.confirm("Are you sure you want to delete this worksheet?")&&this.worksheets.splice(n,1)},t.prototype.moveUp=function(t){n.swapUp(this.worksheets,t)},t.prototype.moveDown=function(t){n.swapDown(this.worksheets,t)},t.prototype.copy=function(t){var i=angular.copy(this.worksheets[t]);i.title=n.ifBlank(i.title,n.defaultWorksheetTitle)+" (Copy)";this.worksheets.push(i);n.swap(this.worksheets,this.worksheets.indexOf(i),t+1)},t.$inject=["$workbook","$window"],t}();t.Controller=i}(u=n.Workbook||(n.Workbook={})),function(t){var i=function(){function t(n,t,i,r,u,f){this.$scope=n;this.$workbook=t;this.$route=i;this.$routeParams=r;this.$window=u;this.$filter=f;(angular.isUndefined(this.index)||angular.isUndefined(this.$workbook.worksheets[this.index]))&&this.$workbook.go()}return Object.defineProperty(t.prototype,"form",{get:function(){return this.$scope.form},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"index",{get:function(){return n.toInt(this.$routeParams.index)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"title",{get:function(){return n.ifBlank(this.worksheet.title,n.defaultWorksheetTitle)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"worksheet",{get:function(){return this.$workbook.worksheets[this.index]},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"judges",{get:function(){return n.ifBlank(this.worksheet.judges,[])},set:function(t){this.worksheet.judges=angular.copy(n.ifBlank(t,[]))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"competitors",{get:function(){return n.ifBlank(this.worksheet.competitors,[])},set:function(t){this.worksheet.competitors=angular.copy(n.ifBlank(t,[]))},enumerable:!0,configurable:!0}),t.$inject=["$scope","$workbook","$route","$routeParams","$window","$filter"],t}();t.Controller=i}(t=n.Worksheet||(n.Worksheet={})),function(n){var i=function(n){function t(){var t=n!==null&&n.apply(this,arguments)||this;return t.ranks=["1st","2nd","3rd","4th","5th","6th","7th","8th"],t.tabs=["Scoring","Calculation","Results"],t.tab=t.tabs[0],t}return __extends(t,n),Object.defineProperty(t.prototype,"tops",{get:function(){return this.$filter("limitTo")([1,2,3,4,5,6,7,8],this.competitors.length)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"top",{get:function(){return this.worksheet.top>=1&&this.worksheet.top<=this.competitors.length||(this.worksheet.top=this.competitors.length>3?3:this.competitors.length),this.worksheet.top},set:function(n){this.worksheet.top=n},enumerable:!0,configurable:!0}),t.prototype.setTab=function(n,t){t.preventDefault();t.stopPropagation();this.tabs.indexOf(n)>0&&this.calculate();this.tab=n},Object.defineProperty(t.prototype,"tabIndex",{get:function(){return this.tabs.indexOf(this.tab)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"validateJudges",{get:function(){return this.$workbook.validateJudges(this.judges)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"validateCompetitors",{get:function(){return this.$workbook.validateCompetitors(this.competitors)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"templateUrl",{get:function(){return this.validateJudges?this.validateCompetitors?"Views/"+this.tab.toLowerCase()+".html":"Views/setup.html":"Views/setup.html"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"message",{get:function(){return this.form.$error.required?"Each judge must rank every competitor":this.form.$error.parse||this.form.$error.min||this.form.$error.max?"Each score must be a numeric rank between 1 and "+this.competitors.length:this.form.$error.duplicate?"Competitors cannot be tied by any judge":void 0},enumerable:!0,configurable:!0}),t.prototype.calculate=function(){var i=this,u=Math.ceil(this.worksheet.judges.length/2),n,r,t;for(this.worksheet.competitors.forEach(function(n){var r,f,e,t;for(n.tally=[],r=1;r<=i.competitors.length;r++){for(f=0,e=0,t=0;t<i.judges.length;t++)n.scores[t]<=r&&(f++,e+=n.scores[t]);f>=u?n.tally.push(-f,e):n.tally.push(null,null)}}),n=[],console.log("Predicates",n),r=function(t){n.push(function(n){return n.tally[t]})},t=0;t<this.competitors.length*2;t++)r(t);this.$filter("orderBy")(this.competitors,n).forEach(function(n,t){n.rank=t+1})},t.prototype.copy=function(){console.log("copy");var n={title:this.worksheet.title+" (Copy)",judges:angular.copy(this.judges),competitors:[]};this.$filter("orderBy")(this.$filter("limitTo")(this.$filter("orderBy")(this.competitors,"rank"),this.top),"id").forEach(function(t){n.competitors.push({id:t.id,name:t.name,scores:[]})});this.$workbook.worksheets.push(n);this.$workbook.go("/worksheets",this.$workbook.worksheets.indexOf(n))},t}(t.Controller);n.Controller=i}(f=n.Scoring||(n.Scoring={})),function(n){function i(){return function(){return{restrict:"A",controller:t,controllerAs:"$score",bindToController:!0,require:{form:"^^form",ngModel:"ngModel",integer:"integer"},priority:50}}}var t=function(){function n(n){this.$scope=n}return Object.defineProperty(n.prototype,"worksheet",{get:function(){return this.$scope.$ctrl.worksheet},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"c",{get:function(){return this.$scope.$parent.$index},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"j",{get:function(){return this.$scope.$index},enumerable:!0,configurable:!0}),n.prototype.name=function(n,t){return n===void 0&&(n=this.c),t===void 0&&(t=this.j),"c"+n+"j"+t},Object.defineProperty(n.prototype,"tabIndex",{get:function(){return this.j*this.worksheet.competitors.length+(this.c+1)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"value",{get:function(){return this.worksheet.competitors[this.c].scores[this.j]},set:function(n){this.worksheet.competitors[this.c].scores[this.j]=n},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"ngClass",{get:function(){return{"is-valid":this.ngModel.$valid,"is-invalid":this.ngModel.$invalid}},enumerable:!0,configurable:!0}),n.prototype.$postLink=function(){var n=this;this.ngModel.$validators.min=function(n){return n>=1};this.ngModel.$validators.max=function(t){return t<=n.worksheet.competitors.length};this.ngModel.$validators.duplicate=function(t){for(var i=n.c+1;i<n.worksheet.competitors.length;i++)if(t===n.worksheet.competitors[i].scores[n.j])return!1;return!0};this.ngModel.$viewChangeListeners.push(function(){for(var i,t=0;t<n.c;t++)i=n.form[n.name(t,n.j)],i.$validate()})},n.$inject=["$scope"],n}();n.Controller=t;n.DirectiveFactory=i}(e=n.Score||(n.Score={})),function(i){var r=function(t){function i(n,i,r,u,f,e){var o=t.call(this,n,i,r,u,f,e)||this;return o.$scope=n,o.$workbook=i,o.$route=r,o.$routeParams=u,o.$window=f,o.$filter=e,(angular.isUndefined(o.index)||angular.isUndefined(o.$workbook.worksheets[o.index]))&&o.$workbook.go(),n.$on("$destroy",n.$on("$routeChangeStart",function(n){o.form&&o.form.$dirty&&(n.preventDefault(),o.$window.alert("Please save or undo your changes before continuing."))})),o}return __extends(i,t),Object.defineProperty(i.prototype,"validator",{get:function(){return this.$workbook[this.property.toLowerCase()+"ValidationError"]},enumerable:!0,configurable:!0}),i.prototype.getData=function(t,i,r){return this.property=n.ifBlank(t,this.property),this.min=n.ifBlank(i,this.min),this.max=n.ifBlank(r,this.max),angular.copy(this[this.property.toLowerCase()])},Object.defineProperty(i.prototype,"rowTemplate",{get:function(){return"Views/"+this.property.toLowerCase()+".html"},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"message",{get:function(){return n.ifBlank(this.validator(this.data),this.property)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"valid",{get:function(){return n.isBlank(this.validator(this.data))},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"invalid",{get:function(){return!this.valid},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"canAdd",{get:function(){return this.data.length<this.max},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"canRemove",{get:function(){return this.data.length>this.min},enumerable:!0,configurable:!0}),i.prototype.remove=function(n){this.data.splice(n,1);this.form.$setDirty()},i.prototype.moveUp=function(t){n.swapUp(this.data,t);this.form.$setDirty()},i.prototype.moveDown=function(t){n.swapDown(this.data,t);this.form.$setDirty()},i.prototype.save=function(){this[this.property.toLowerCase()]=angular.copy(n.ifBlank(this.data,[]));this.form.$setPristine()},i.prototype.undo=function(){this.data=this.getData();this.form.$setPristine()},i.prototype.goToWorksheet=function(){this.$workbook.go("/worksheets",this.index)},i}(t.Controller);i.EditController=r}(i=n.Editor||(n.Editor={})),function(t){var r=function(t){function i(){var i=t!==null&&t.apply(this,arguments)||this;return i.data=i.getData("Judges",3,n.maxJudges),i}return __extends(i,t),i.prototype.add=function(){this.data.push({name:null});this.form.$setDirty()},i}(i.EditController);t.Controller=r}(o=n.Judges||(n.Judges={})),function(t){var r=function(t){function i(){var i=t!==null&&t.apply(this,arguments)||this;return i.data=i.getData("Competitors",2,n.maxCompetitors),i}return __extends(i,t),i.prototype.add=function(){var n=this.data.push({id:null,name:null,scores:[]});this.data[n-1].id=n;this.form.$setDirty()},i}(i.EditController);t.Controller=r}(s=n.Competitors||(n.Competitors={})),function(t){function r(){return function(){return{restrict:"A",controller:i,bindToController:!0,require:{ngModel:"ngModel"},priority:100}}}var i=function(){function t(){}return t.prototype.$postLink=function(){var t=this;this.ngModel.$parsers.unshift(function(i){return t.ngModel.$isEmpty(i)?i:n.toInt(i)})},t}();t.Controller=i;t.DirectiveFactory=r}(h=n.Integer||(n.Integer={})),function(n){function i(){return function(){return{restrict:"A",scope:!1,controller:t}}}var t=function(){function n(n,t,i,r,u){var f=this;this.$scope=n;this.$element=t;this.$workbook=i;this.$location=r;this.$window=u;this.onChange=function(n){var i,t;f.$window.confirm("The current workbook will be overwritten. Are you sure you want to continue?")&&(i=n.target,i.files.length)&&(t=new FileReader,t.onload=function(){f.$scope.$apply(function(){f.$workbook.workbook=angular.fromJson(t.result);f.$location.path("/workbook")})},t.readAsText(i.files[0]))}}return n.prototype.$postLink=function(){this.$element.bind("change",this.onChange)},n.$inject=["$scope","$element","$workbook","$location","$window"],n}();n.Controller=t;n.DirectiveFactory=i}(c=n.Upload||(n.Upload={}))}(RPCalculator||(RPCalculator={}));module.service("$workbook",RPCalculator.Workbook.Service);module.controller("menuController",RPCalculator.Menu.Controller);module.directive("integer",RPCalculator.Integer.DirectiveFactory());module.directive("score",RPCalculator.Score.DirectiveFactory());module.directive("upload",RPCalculator.Upload.DirectiveFactory());